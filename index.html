import os
import json

# Assume the project root is now 'App_Teams'
project_dir = "App_Teams"

# Ensure we are in the project root directory where manifest.json should be
try:
    os.chdir(f'/content/{project_dir}')
    print(f"Changed directory to /content/{project_dir}")
except FileNotFoundError:
    print(f"Could not change directory to /content/{project_dir}. Please ensure the directory exists and you are in the correct parent directory.")


manifest_path = "manifest.json"

# Load the existing manifest content
try:
    with open(manifest_path, "r") as f:
        manifest_content = json.load(f)
    print(f"Loaded existing manifest from {manifest_path}")

    # Add or update the configurableTabs section
    # This example adds a simple configurable tab pointing to the simple web interface HTML file
    # The URL should be the publicly accessible URL where your index.html is hosted
    manifest_content["configurableTabs"] = [
        {
            "configurationUrl": "https://your-hosted-frontend-url/App_Teams/frontend/index.html#/config", # URL for configuration page
            "canUpdateConfiguration": True,
            "scopes": [
                "team",
                "groupchat",
                "personal"
            ]
        }
    ]

    # Add or update the staticTabs section as an alternative/addition for a simpler personal tab
    # The contentUrl should point to the index.html file within the hosted App_Teams/frontend directory
    manifest_content["staticTabs"] = [
         {
             "entityId": "knowledgeRagStaticTab",
             "name": "Knowledge RAG",
             "contentUrl": "https://your-hosted-frontend-url/App_Teams/frontend/index.html", # URL to the content page
             "scopes": [
                 "personal"
             ]
         }
     ]


    # Update validDomains to include the domain where your frontend is hosted
    # You will need to replace "your-hosted-frontend-url" with the actual domain
    hosted_frontend_domain = "your-hosted-frontend-url" # REPLACE THIS WITH YOUR ACTUAL HOSTED DOMAIN
    # Extract domain from URL if it starts with http(s)
    if hosted_frontend_domain.startswith("http"):
        from urllib.parse import urlparse
        parsed_url = urlparse(hosted_frontend_domain)
        hosted_frontend_domain = parsed_url.netloc

    if hosted_frontend_domain and hosted_frontend_domain not in manifest_content["validDomains"]:
         manifest_content["validDomains"].append(hosted_frontend_domain)
         print(f"Added '{hosted_frontend_domain}' to validDomains.")
    elif not hosted_frontend_domain:
         print("Warning: Could not extract domain from the hosted frontend URL. Please manually add the domain to validDomains.")


    # Decide whether to keep or remove the 'bots' section.
    # If you are ONLY using a Tab, you can remove the 'bots' section.
    # If you want both a Bot and a Tab, keep it.
    # For this path focused on the Tab, let's assume we remove the bot section for clarity in the manifest.
    if "bots" in manifest_content:
         del manifest_content["bots"]
         print("Removed 'bots' section from manifest as we are focusing on a Tab.")


    # Save the updated manifest content
    with open(manifest_path, "w") as f:
        json.dump(manifest_content, f, indent=4)

    print(f"Teams application manifest updated at: {manifest_path}")

except FileNotFoundError:
    print(f"Error: manifest.json not found at {manifest_path}. Please ensure the file exists in the project root '{project_dir}'.")
except json.JSONDecodeError:
    print(f"Error: Could not decode JSON from {manifest_path}. Please check the file content.")
except Exception as e:
    print(f"An unexpected error occurred: {e}")


# Note:
# 1. Replace "https://your-hosted-frontend-url" and "your-hosted-frontend-url"
#    with the actual public URL and domain where you will host your `index.html` file.
#    The `contentUrl` and `configurationUrl` in the manifest must point to a publicly
#    accessible URL.
# 2. We've added both `configurableTabs` and `staticTabs` as examples. You should
#    typically choose one based on whether your tab needs per-instance configuration.
#    For a simple PoC, a static tab is often sufficient. You can remove the section
#    you don't need from the manifest after this step.
# 3. We've removed the 'bots' section as we are focusing on the Tab integration path.
